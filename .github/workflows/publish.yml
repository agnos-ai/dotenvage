name: Publish CLI

on:
    workflow_dispatch:
        inputs:
            post:
                name: "Release Post"
                required: true
                description: Choose the release post to publish with. Must be a tag (eg v0.0.8)
                type: string
            channel:
                name: "CLI Binary Version"
                required: true
                description: Choose the version number to publish with. Must be a tag (ie v0.0.8)
                type: string

env:
    RELEASE_TAG: ${{ github.event.inputs.channel }}
    RELEASE_POST: ${{ github.event.inputs.post }}

jobs:
    release-cli:
        permissions:
            contents: write
        runs-on: ${{ matrix.platform.os }}
        strategy:
            matrix:
                platform:
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                    - target: aarch64-pc-windows-msvc
                      os: windows-latest
                    - target: x86_64-apple-darwin
                      os: macos-15-intel
                    - target: aarch64-apple-darwin
                      os: macos-15-xlarge
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-24.04
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-24.04-arm

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: refs/tags/${{ env.RELEASE_POST }}

            - name: Install dependencies (Ubuntu)
              if: ${{ matrix.platform.os == 'ubuntu-24.04' || matrix.platform.os == 'ubuntu-24.04-arm' }}
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev libxdo-dev libglib2.0-dev musl-tools
                  version: 1.0

            - name: Install Rust
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: stable
                  targets: ${{ matrix.platform.target }}

            - name: Cache Rust
              uses: Swatinem/rust-cache@v2
              with:
                  cache-all-crates: "true"
                  save-if: ${{ github.ref == 'refs/heads/main' }}

            - name: Free Disk Space (Ubuntu)
              if: ${{ matrix.platform.os == 'ubuntu-24.04' || matrix.platform.os == 'ubuntu-24.04-arm' }}
              uses: jlumbroso/free-disk-space@v1.3.1
              with:
                  large-packages: false
                  docker-images: false
                  swap-storage: false

            - name: Build and upload CLI binaries
              uses: taiki-e/upload-rust-binary-action@v1
              with:
                  bin: dotenvage
                  token: ${{ secrets.GITHUB_TOKEN }}
                  target: ${{ matrix.platform.target }}
                  archive: $bin-$target
                  checksum: sha256
                  manifest_path: Cargo.toml
                  ref: refs/tags/${{ env.RELEASE_POST }}
                  zip: "all"
